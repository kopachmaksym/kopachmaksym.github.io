<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Simple PWA</title>
    <meta name="theme-color" content="#2b2bff" />
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Apple —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Ç–µ–≥–∏ -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Simple PWA" />
    <link rel="apple-touch-icon" href="/icons/icon-128.png" />
    <style>
        :root { --accent:#2b2bff; font-family: system-ui,Segoe UI,Roboto,Helvetica,Arial; }
        body{ margin:0; padding:1rem; color:#222; }
        header{ display:flex; align-items:center; gap:.75rem; }
        .badge{ background:var(--accent); color:#fff; padding:.25rem .5rem; border-radius:.375rem; }
        #offline { display:none; background:#ffdede; padding:.5rem; margin-top:1rem; border-radius:.375rem; }
        button{ padding:.5rem .75rem; border:1px solid #ccc; border-radius:.375rem; background:#fff; cursor:pointer; }
        input, select, textarea { padding:.5rem; margin:.5rem 0; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:.375rem; }
        .form-group { margin:1rem 0; }
        label { display:block; font-weight:bold; margin-bottom:.25rem; }
        .animal-item { background:#f5f5f5; padding:1rem; margin:1rem 0; border-radius:.375rem; border-left:4px solid var(--accent); }
        .animal-item h3 { margin:.5rem 0; color:var(--accent); }
        .animal-item p { margin:.25rem 0; font-size:.9rem; }
        .success { background:#d4edda; color:#155724; padding:.75rem; margin:1rem 0; border-radius:.375rem; }
        .error { background:#f8d7da; color:#721c24; padding:.75rem; margin:1rem 0; border-radius:.375rem; }
    </style>
</head>
<body>
    <header>
        <div class="badge">üêæ PWA</div>
        <h1 style="margin:0;font-size:1.25rem;">Animal Shelter</h1>
    </header>

    <p>–î–æ–¥–∞–π—Ç–µ —Ç–≤–∞—Ä–∏–Ω—É –¥–æ –ø—Ä–∏—Ç—É–ª–∫—É —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–¥–∞–π—Ç–µ —Å–ø–∏—Å–æ–∫.</p>

    <div>
        <button id="installBtn" style="display:none">Install App</button>
        <button id="checkOffline">Check Offline</button>
    </div>

    <div id="offline">You are offline ‚Äî showing cached content.</div>

    <!-- Add Animal Form -->
    <div style="background:#fff; padding:1rem; border:1px solid #ddd; border-radius:.375rem; margin:1rem 0;">
        <h2>–î–æ–¥–∞—Ç–∏ —Ç–≤–∞—Ä–∏–Ω—É</h2>
        <form id="animalForm">
            <div class="form-group">
                <label>–ö–ª–∏—á–∫–∞:</label>
                <input type="text" id="nickname" required />
            </div>

            <div class="form-group">
                <label>–°—Ç–∞—Ç—å:</label>
                <select id="sex" required>
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å</option>
                    <option value="0">–°–∞–º–∫–∞</option>
                    <option value="1">–°–∞–º–µ—Ü—å</option>
                    <option value="2">–ù–µ–≤—ñ–¥–æ–º–æ</option>
                </select>
            </div>

            <div class="form-group">
                <label>–í–∏–¥:</label>
                <select id="species" required>
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å</option>
                    <option value="1">–ö—ñ—Ç</option>
                    <option value="3">–°–æ–±–∞–∫–∞</option>
                </select>
            </div>

            <div class="form-group">
                <label>–ö–æ–ª—ñ—Ä:</label>
                <input type="text" id="color" />
            </div>

            <div class="form-group">
                <label>–†–æ–∑–º—ñ—Ä:</label>
                <select id="animal_size">
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å</option>
                    <option value="1">–ú–∞–ª–µ–Ω—å–∫–∞</option>
                    <option value="2">–°–µ—Ä–µ–¥–Ω—è</option>
                    <option value="3">–í–µ–ª–∏–∫–∞</option>
                </select>
            </div>

            <div class="form-group">
                <label>–í–∞–≥–∞ (—Å—Ç–∞—Ç—É—Å):</label>
                <select id="_weight" required>
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å</option>
                    <option value="1">–í–∏—Å–Ω–∞–∂–µ–Ω–∞</option>
                    <option value="2">–•—É–¥–∞</option>
                    <option value="3">–ù–æ—Ä–º–∞–ª—å–Ω–∞</option>
                    <option value="4">–¢–æ–≤—Å—Ç–∞</option>
                    <option value="5">–û–∂–∏—Ä—ñ–Ω–Ω—è</option>
                </select>
            </div>

            <div class="form-group">
                <label>–û–ø–∏—Å:</label>
                <textarea id="_short_description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label>–°—Ç–µ—Ä–∏–ª—ñ–∑–æ–≤–∞–Ω–∞:</label>
                <select id="sterilization">
                    <option value="false">–ù—ñ</option>
                    <option value="true">–¢–∞–∫</option>
                </select>
            </div>

            <div class="form-group">
                <label>–§–æ—Ç–æ:</label>
                <input type="file" id="photo" accept="image/*" />
            </div>

            <div class="form-group">
                <label>–ö—É–ª—å–≥–∞–≤—ñ—Å—Ç—å:</label>
                <select id="_lame">
                    <option value="0">–ù—ñ</option>
                    <option value="1">–¢–∞–∫</option>
                </select>
            </div>

            <div class="form-group">
                <label>–ü—Ä–æ–±–ª–µ–º–∏ –∑ —à–∫—ñ—Ä–æ—é:</label>
                <select id="_skin_problem">
                    <option value="0">–ù—ñ</option>
                    <option value="1">–¢–∞–∫</option>
                </select>
            </div>

            <div class="form-group">
                <label>–î–∏—Ç–∏–Ω—á–∞:</label>
                <select id="_baby">
                    <option value="0">–ù—ñ</option>
                    <option value="1">–¢–∞–∫</option>
                </select>
            </div>

            <div class="form-group">
                <label>–í–∞–≥—ñ—Ç–Ω–∞/–õ–∞–∫—Ç—É—é—á–∞:</label>
                <select id="_preg_lact">
                    <option value="0">–ù—ñ</option>
                    <option value="1">–¢–∞–∫</option>
                </select>
            </div>

            <div class="form-group">
                <label>–í–ª–∞—Å–Ω–∏–∫:</label>
                <select id="_owner">
                    <option value="1">–ü—Ä–∏—Ç—É–ª–æ–∫</option>
                    <option value="">–ë–µ–∑ –≤–ª–∞—Å–Ω–∏–∫–∞</option>
                </select>
            </div>

            <button type="submit" style="background:var(--accent); color:#fff; border:none; cursor:pointer;">–î–æ–¥–∞—Ç–∏ —Ç–≤–∞—Ä–∏–Ω—É</button>
        </form>
        <div id="message"></div>
    </div>

    <!-- Animals List -->
    <div>
        <h2>–°–ø–∏—Å–æ–∫ —Ç–≤–∞—Ä–∏–Ω</h2>
        <div id="animalsList"></div>
    </div>

    <script>
        const API_URL = 'http://api.animal-id.info/homeless_v1/animal';
        const TOKEN = 'Bearer okRpmDg2wJeyLPbD14tDcbrgeYOX8ltv';

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg=>{
                console.log('SW registered:', reg.scope);
            }).catch(err=>{
                console.warn('SW registration failed:', err);
            });
        }

        // Offline indicator
        const offlineEl = document.getElementById('offline');
        function updateOnlineStatus(){ offlineEl.style.display = navigator.onLine ? 'none' : 'block'; }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        document.getElementById('checkOffline').addEventListener('click', updateOnlineStatus);
        updateOnlineStatus();

        // Install prompt
        const isIphone = /iPhone|iPad|iPod/.test(navigator.userAgent);
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        
        if (isIphone) {
            installBtn.textContent = 'üì± Add to Home Screen';
            installBtn.style.display = 'inline-block';
            installBtn.addEventListener('click', () => {
                alert('–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Share (–≤–Ω–∏–∑—É) ‚Üí Add to Home Screen');
            });
        } else {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'inline-block';
            });
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const choice = await deferredPrompt.userChoice;
                console.log('Install choice:', choice.outcome);
                deferredPrompt = null;
                installBtn.style.display = 'none';
            });
        }

        // Add Animal Form Handler
        const form = document.getElementById('animalForm');
        const messageDiv = document.getElementById('message');
        const animalsList = document.getElementById('animalsList');
        let animals = JSON.parse(localStorage.getItem('animals')) || [];

        // Display animals from localStorage
        function displayAnimals() {
            animalsList.innerHTML = animals.map((animal, idx) => `
                <div class="animal-item">
                    <h3>${animal.nickname} ${animal.species === 1 ? 'üê±' : 'üê∂'}</h3>
                    <p><strong>–ü–æ—Ä–æ–¥–∞:</strong> ${animal.breed || '-'}</p>
                    <p><strong>–í–∏–¥:</strong> ${animal.species === 1 ? '–ö—ñ—Ç' : '–°–æ–±–∞–∫–∞'}</p>
                    <p><strong>–°—Ç–∞—Ç—å:</strong> ${['–°–∞–º–∫–∞', '–°–∞–º–µ—Ü—å', '–ù–µ–≤—ñ–¥–æ–º–æ'][animal.sex] || '-'}</p>
                    <p><strong>–ö–æ–ª—ñ—Ä:</strong> ${animal.color || '-'}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å –≤–∞–≥–∏:</strong> ${['', '–í–∏—Å–Ω–∞–∂–µ–Ω–∞', '–•—É–¥–∞', '–ù–æ—Ä–º–∞–ª—å–Ω–∞', '–¢–æ–≤—Å—Ç–∞', '–û–∂–∏—Ä—ñ–Ω–Ω—è'][animal._weight] || '-'}</p>
                    <p><strong>–°—Ç–µ—Ä–∏–ª—ñ–∑–æ–≤–∞–Ω–∞:</strong> ${animal.sterilization ? '–¢–∞–∫' : '–ù—ñ'}</p>
                    <p><strong>–û–ø–∏—Å:</strong> ${animal._short_description || '-'}</p>
                    ${animal.photoUrl ? `<img src="${animal.photoUrl}" style="max-width:100%; border-radius:.375rem; margin-top:.5rem;" />` : ''}
                    <button onclick="deleteAnimal(${idx})" style="background:#dc3545; color:#fff; border:none; margin-top:.5rem; padding:.5rem .75rem; border-radius:.375rem; cursor:pointer;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </div>
            `).join('');
        }

        function deleteAnimal(idx) {
            animals.splice(idx, 1);
            localStorage.setItem('animals', JSON.stringify(animals));
            displayAnimals();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            messageDiv.innerHTML = '<div class="success">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...</div>';

            const formData = new FormData();
            
            // –î–æ–¥–∞–π—Ç–µ –≤—Å—ñ –ø–æ–ª—è —è–∫ form-data
            formData.append('breed', document.getElementById('nickname').value + ' –ø–æ—Ä–æ–¥–∞');
            formData.append('sex', document.getElementById('sex').value);
            formData.append('nickname', document.getElementById('nickname').value);
            formData.append('species', document.getElementById('species').value);
            formData.append('sterilization', document.getElementById('sterilization').value === 'true' ? 1 : 0);
            formData.append('color', document.getElementById('color').value);
            formData.append('animal_size', document.getElementById('animal_size').value || 2);
            formData.append('birth_date', Math.floor(Date.now() / 1000));
            formData.append('_long', -1.0);
            formData.append('_lat', -1.0);
            formData.append('_weight', document.getElementById('_weight').value || 3);
            formData.append('_lame', document.getElementById('_lame').value);
            formData.append('_skin_problem', document.getElementById('_skin_problem').value);
            formData.append('_baby', document.getElementById('_baby').value);
            formData.append('_preg_lact', document.getElementById('_preg_lact').value);
            formData.append('_owner', document.getElementById('_owner').value || null);
            formData.append('_short_description', document.getElementById('_short_description').value);
            formData.append('created_at', Math.floor(Date.now() / 1000));

            // –§–æ—Ç–æ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
            const photoInput = document.getElementById('photo');
            if (photoInput.files.length > 0) {
                formData.append('photo', photoInput.files[0]);
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': TOKEN
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    messageDiv.innerHTML = '<div class="success">‚úÖ –¢–≤–∞—Ä–∏–Ω—É —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ! ID: ' + result.id + '</div>';
                    
                    const animalData = {
                        nickname: document.getElementById('nickname').value,
                        species: parseInt(document.getElementById('species').value),
                        breed: document.getElementById('nickname').value + ' –ø–æ—Ä–æ–¥–∞',
                        sex: parseInt(document.getElementById('sex').value),
                        color: document.getElementById('color').value,
                        _weight: parseInt(document.getElementById('_weight').value) || 3,
                        sterilization: document.getElementById('sterilization').value === 'true',
                        _short_description: document.getElementById('_short_description').value,
                        photoUrl: result.photo_url || null
                    };

                    animals.push(animalData);
                    localStorage.setItem('animals', JSON.stringify(animals));
                    form.reset();
                    displayAnimals();
                    setTimeout(() => messageDiv.innerHTML = '', 5000);
                } else {
                    const error = await response.text();
                    messageDiv.innerHTML = '<div class="error">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error + '</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                messageDiv.innerHTML = '<div class="error">‚ùå –ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ó–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.</div>';
                animals.push({
                    nickname: document.getElementById('nickname').value,
                    species: parseInt(document.getElementById('species').value),
                    _short_description: document.getElementById('_short_description').value
                });
                localStorage.setItem('animals', JSON.stringify(animals));
                displayAnimals();
            }
        });

        displayAnimals();
    </script>
</body>
</html>